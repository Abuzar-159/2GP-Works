<template>
      <template if:true={isLoading}>
        <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
    </template>
    <div class="slds-p-around_medium body" style="background:#F7F8F9; min-height: 81vh;">
            <template if:false={isShipmentRatesOpen}>

        <div class="slds-grid slds-wrap slds-gutters">

           
    <div class="slds-col slds-size_1-of-1 slds-large-size_7-of-12">

        <div class="slds-m-bottom_medium slds-border_bottom slds-border_top slds-border_left slds-border_right"
            style="border-radius: 4px; background: white; border:1px solid #ede8e8;">
            <div class="slds-p-around_medium">
                <img src={freightviewImg} alt="Freightview Logo" style="height:70px;"
                    class="slds-m-right_small" />
            </div>
        </div>

        <lightning-accordion allow-multiple-sections-open active-section-name={activeSections} onsectiontoggle={handleAccordionToggle}>

            <lightning-accordion-section name="destination" label="Where is this shipment going?" icon-name="action:map" style="background:white;border-radius:6px;">
                <div class="slds-p-horizontal_small slds-p-vertical_small">
                    <div class="slds-grid slds-wrap slds-gutters_small">
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <label class="slds-form-element__label" for="unique-input-id">
                                To Address
                            </label>
                            <c-custom-input-lookup-l-w-c obj-name="Address__c" search-placeholder="Search address"
                                icon-name="standard:address" is-value-selected={toAddressSelected}
                                selected-value={toAddress.Id} selected-name={toAddress.Name}
                                selected-name-url={toAddressUrl} hide-remove="true"> </c-custom-input-lookup-l-w-c>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <div class="slds-grid">
                                <label>Company</label>&nbsp;
                                <div class="required">*</div>
                            </div>
                            <template lwc:if={toContact.Company__c}>
                                <lightning-input type="text" label={label.CompanyLabel}
                                    value={toContact.Company__r.Name} variant="label-hidden"></lightning-input>
                            </template>
                            <template lwc:elseif={toAddress.Customer__r.Company_txt__c}>
                                <lightning-input type="text" label={label.CompanyLabel}
                                    value={toAddress.Customer__r.Company_txt__c}
                                    variant="label-hidden"></lightning-input>
                            </template>
                            <template lwc:else>
                                <lightning-input type="text" label={label.CompanyLabel}
                                    value={toContact.Account.Name} variant="label-hidden"></lightning-input>
                            </template>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <div class="slds-grid">
                                <label>Email</label>&nbsp;
                                <div class="required">*</div>
                            </div>
                            <div lwc:if={toContact.Email}>
                                <lightning-input type="text" label="Email" value={toContact.Email}
                                    variant="label-hidden"></lightning-input>
                            </div>
                            <div lwc:else>
                                <lightning-input type="text" label="Email" value={toContact.Account.Email__c}
                                    variant="label-hidden"></lightning-input>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Address Line 1"
                                value={toAddress.Address_Line1__c}></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Address Line 2"
                                value={toAddress.Address_Line2__c}></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <div class="slds-grid">
                                <label>{label.PhoneLabel}</label>&nbsp;
                                <div class="required">*</div>
                            </div>
                            <div lwc:if={toContact.Phone}>
                                <lightning-input type="text" label={label.PhoneLabel}
                                    value={toContact.Phone} variant="label-hidden"></lightning-input>
                            </div>
                            <div lwc:else>
                                <lightning-input type="text" label={label.PhoneLabel}
                                    value={toContact.Account.Phone}
                                    variant="label-hidden"></lightning-input>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="City/Town" value={toAddress.City__c}></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <div
                                class="slds-form-element__control slds-input-has-icon slds-input-has-icon--right">
                                <div class="slds-grid">
                                    <label>Contact</label>
                                    <div class="required">*</div>
                                </div>
                                <lightning-input type="text" value={toContact.Name}
                                    variant="label-hidden"></lightning-input>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="State/County" value={toAddress.State__c}></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Zip/Postal Code"
                                value={toAddress.Postal_Code__c}></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Country" value={toAddress.Country__c}></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Opens at" value={formattedOpensAt}></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Closes at" value={formattedClosesAt}></lightning-input>
                        </div>
                        </div>
                </div>
            </lightning-accordion-section>

            <lightning-accordion-section name="origin" label="Where is this shipment coming from?" style="background:white;border-radius:6px;">
                <div class="slds-p-horizontal_small slds-p-vertical_small">
                    <div class="slds-grid slds-wrap slds-gutters_small">
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <label class="slds-form-element__label" for="unique-input-id">
                                From Address
                            </label>
                            <c-custom-input-lookup-l-w-c obj-name="Address__c" search-placeholder="Search address"
                                icon-name="standard:address" is-value-selected={FromAddressSelected}
                                selected-value={fromAddress.Id} selected-name={fromAddress.Name}
                                selected-name-url={fromAddressUrl} hide-remove="true">
                            </c-custom-input-lookup-l-w-c>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <div class="slds-grid">
                                <label>Company</label>&nbsp;
                                <div class="required">*</div>
                            </div>
                            <template lwc:if={fromContact.Company__c}>
                                <lightning-input type="text" label={label.CompanyLabel}
                                    value={fromContact.Company__r.Name} variant="label-hidden"></lightning-input>
                            </template>
                            <template lwc:elseif={fromAddress.Customer__r.Company_txt__c}>
                                <lightning-input type="text" label={label.CompanyLabel}
                                    value={fromAddress.Customer__r.Company_txt__c}
                                    variant="label-hidden"></lightning-input>
                            </template>
                            <template lwc:else>
                                <lightning-input type="text" label={label.CompanyLabel}
                                    value={fromContact.Account.Name} variant="label-hidden"></lightning-input>
                            </template>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <div class="slds-grid">
                                <label>Email</label>&nbsp;
                                <div class="required">*</div>
                            </div>
                            <div lwc:if={fromContact.Email}>
                                <lightning-input type="text" variant="label-hidden" value={fromContact.Email}
                                    ></lightning-input>
                            </div>
                            <div lwc:else>
                                <lightning-input type="text" variant="label-hidden" value={fromContact.Account.Email__c}
                                    ></lightning-input>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Address Line 1" value={fromAddress.Address_Line1__c}
                                ></lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Address Line 2" value={fromAddress.Address_Line2__c}
                                ></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <div class="slds-grid">
                                <label>Phone</label>&nbsp;
                                <div class="required">*</div>
                            </div>
                            <div lwc:if={fromContact.Phone}>
                                <lightning-input type="text" variant="label-hidden" value={fromContact.Phone}
                                    ></lightning-input>
                            </div>
                            <div lwc:else>
                                <lightning-input type="text" variant="label-hidden" value={fromContact.Account.Phone}></lightning-input>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="City/Town" value={fromAddress.City__c}
                                ></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <div class="slds-grid">
                                <label>Contact</label>
                                <div class="required">*</div>
                            </div>
                            <div>
                                <lightning-input type="text" variant="label-hidden" value={fromContact.Name}
                                    ></lightning-input>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="State/County" value={fromAddress.State__c}
                                ></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Zip/Postal Code" value={fromAddress.Postal_Code__c}
                                ></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Country" value={fromAddress.Country__c}
                                ></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Opens at" value={formattedFromOpensAt}
                                ></lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <lightning-input label="Closes at" value={formattedFromClosesAt}></lightning-input>
                        </div>
                        </div>
                </div>
            </lightning-accordion-section>

            <lightning-accordion-section name="shipmentDetails" label="What are you shipping?" style="background:white;border-radius:6px;">
                <div class="slds-p-horizontal_small slds-p-vertical_small">
                    <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                        <thead>
                            <tr class="slds-line-height_reset">
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Package">Package</div>
                                </th>
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Order">Order</div>
                                </th>
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Weight">Weight</div>
                                </th>
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Length">Length</div>
                                </th>
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Width">Width</div>
                                </th>
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Height">Height</div>
                                </th>
                                <th class="" scope="col">
                                    <div class="slds-truncate" title="Declared Value">Declared Value</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template if:true={packageList} for:each={packageList} for:item="pck" for:index="index">
                                <tr key={pck.Id}>
                                    <td class="greyheadlabel">
                                        <div class="slds-truncate2">
                                            <lightning-formatted-url label={pck.Name} value={pck.packUrl}
                                                target="_blank"></lightning-formatted-url>
                                        </div>
                                    </td>
                                    <td class="greyheadlabel">
                                        <div class="slds-truncate2">
                                            <template if:true={pck.Sales_Order__c}>
                                                <lightning-formatted-text
                                                    value={pck.Sales_Order__r.Name}></lightning-formatted-text>
                                            </template>
                                            <template if:true={pck.Transfer_Order__c}>
                                                <lightning-formatted-text
                                                    value={pck.Transfer_Order__r.Name}></lightning-formatted-text>
                                            </template>
                                            <template if:true={pck.Order__c}>
                                                <lightning-formatted-text
                                                    value={pck.Order__r.Name}></lightning-formatted-text>
                                            </template>
                                            <template if:true={pck.Return_Merchandise_Authorisation__c}>
                                                <lightning-formatted-text
                                                    value={pck.Return_Merchandise_Authorisation__r.Name}></lightning-formatted-text>
                                            </template>
                                        </div>
                                    </td>
                                    <td class="greyheadlabel">
                                        <div class="slds-truncate2">
                                            {pck.Weight__c}
                                        </div>
                                    </td>
                                    <td class="greyheadlabel">
                                        <div class="slds-truncate2">
                                            {pck.Length__c}
                                        </div>
                                    </td>
                                    <td class="greyheadlabel">
                                        <div class="slds-truncate2">
                                            {pck.Width__c}
                                        </div>
                                    </td>
                                    <td class="greyheadlabel">
                                        <div class="slds-truncate2">
                                            {pck.Height__c}
                                        </div>
                                    </td>
                                    <td class="greyheadlabel">
                                        <div class="slds-truncate2">
                                            <lightning-input type="number" formatter="currency" step="0.01"
                                                value={pck.Declared_Value__c}></lightning-input>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    </div>
            </lightning-accordion-section>
            
            <lightning-accordion-section name="additionalDetails" label="Additional Details" style="background:white;border-radius:6px;">
                <div class="slds-p-horizontal_small slds-p-vertical_small">
                    <div class="slds-grid slds-wrap slds-gutters_small">

                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3">
                            <label class="slds-form-element__label" for="unique-input-id">
                                Emergency Contact
                            </label>
                            <c-custom-input-lookup-l-w-c 
                                obj-name="Contact" 
                                lable="contact" 
                                icon-name="standard:contact" 
                                required={isEmergencyContactRequired}
                                selected-value={emergencyContactId}
                                selected-name={emergencyContactName}
                                onlookupselected={handleEmergencyContactSelected}
                                is-value-selected={isEmergencyContactSelected}
                                selected-name-url={emergencyContactUrl}
                                filter={contactFilter}
                               >
                            </c-custom-input-lookup-l-w-c>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3 slds-m-top_large">
                            <lightning-input type="checkbox" label="schedule Pickup" checked={shipment.schedulePickup__c} onchange={handleSchedulePickupChange}
                                ></lightning-input>
                        </div>
                        <template lwc:if={isTruckload}>
                            <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3 slds-m-top_large">
                            <lightning-input type="checkbox" label="Live Load" checked={shipment.isLiveLoad__c} onchange={handleLiveLoadChange}></lightning-input>
                        </div>
                        </template>
                        
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3"></div>
                    </div>
                    </div>
            </lightning-accordion-section>


            <template lwc:if={isTruckload}>
                <lightning-accordion-section name="truckloadStops" label="Stops (Truckload only)" style="background:white;border-radius:6px;">
                    <div class="slds-p-horizontal_small slds-p-vertical_small">
                        <div class="slds-m-bottom_small">
                            <lightning-button label="Add Stop" onclick={handleAddStop}></lightning-button>
                        </div>

                        <template for:each={computedStops} for:item="s" for:index="idx">
                            <div key={s.id} class="slds-box slds-m-bottom_small slds-grid slds-wrap slds-gutters_small" style="border-radius:6px;">
                            <div class="slds-col slds-size_1-of-1">
                                <div class="slds-text-title_bold">Stop {s.displayIndex}</div>
                            </div>

                            <div class="slds-col slds-size_1-of-1 slds-large-size_2-of-12">
                                <lightning-combobox
                                label="Stop Type"
                                value={s.type}
                                data-index={idx}
                                options={stopTypeOptions}
                                onchange={handleStopTypeChange}>
                                </lightning-combobox>
                            </div>

                            <div class="slds-col slds-size_1-of-1 slds-large-size_6-of-12">
                                <label class="slds-form-element__label">Address</label>
                                <c-custom-input-lookup-l-w-c
                                obj-name="Address__c"
                                search-placeholder="Search address"
                                icon-name="standard:address"
                                is-value-selected={s.isAddressSelected}
                                selected-value={s.addressId}
                                selected-name={s.addressName}
                                onlookupselected={handleStopAddressSelected}
                                data-index={idx}
                                hide-remove="true">
                                </c-custom-input-lookup-l-w-c>
                            </div>
                            <div class="slds-col slds-size_1-of-1">
                                <lightning-textarea label="Instructions" value={s.instructions} data-index={idx} onchange={handleStopInstructions}></lightning-textarea>
                            </div>

                            <div class="slds-col slds-size_1-of-1 slds-text-align_right">
                                <lightning-button-icon icon-name="utility:delete" alternative-text="Remove"
                                                    data-index={idx} onclick={handleRemoveStop}></lightning-button-icon>
                            </div>
                            </div>
                        </template>

                        <div class="slds-text-color_weak slds-text-body_small">
                            Note: Origin and Destination come from the sections above. Stops are intermediate locations included in Truckload rating.
                        </div>
                        </div>
                </lightning-accordion-section>
            </template>

        </lightning-accordion>
        </div>



            <div class="slds-col slds-size_1-of-1 slds-large-size_5-of-12">

                <div class="slds-m-bottom_medium slds-border_bottom slds-border_left slds-border_right slds-border_top"
                    style="border-radius: 4px; background: white;border:1px solid #ede8e8;">
                    <div class="slds-p-around_x-small slds-text-heading_small"
                        style="border-bottom: 1px solid #e0e5ee;">
                        <lightning-icon icon-name="action:new_custom98" size="x-small"
                            class="slds-m-right_x-small"></lightning-icon>
                        <span class="slds-text-heading_small">Shipping Services</span>
                    </div>

                 <!-- New tabs -->
                    <div class="slds-tabs_default">
    <ul class="slds-tabs_default__nav" role="tablist">

        <li class={costTabClass} role="presentation">
            <a href="#" class="slds-tabs_default__link" role="tab"
               tabindex="0" data-id="Cost" onclick={handleTabClick} aria-selected={isCostActive}>
                Cost
            </a>
        </li>

        <template lwc:if={isTruckload}>
            <li class={rfqsTabClass} role="presentation">
                <a href="#" class="slds-tabs_default__link" role="tab"
                   tabindex="-1" data-id="RFQs" onclick={handleTabClick} aria-selected={isRfqsActive}>
                    RFQs
                </a>
            </li>
        </template>

        <template lwc:if={isTruckload}>
            <li class={manualQuoteTabClass} role="presentation">
                <a href="#" class="slds-tabs_default__link" role="tab"
                   tabindex="-1" data-id="ManualQuote" onclick={handleTabClick} aria-selected={isManualQuoteActive}>
                    Manual Quote
                </a>
            </li>
        </template>

        <li class={trackTabClass} role="presentation">
            <a href="#" class="slds-tabs_default__link" role="tab"
               tabindex="-1" data-id="Track" onclick={handleTabClick} aria-selected={isTrackActive}>
                Track
            </a>
        </li>

    </ul>
    
    <div id="tab-content" class="slds-tabs_default__content">
        
        <template if:true={isCostActive}>
            <div class="slds-p-horizontal_small slds-p-vertical_small">
                <div class="slds-grid slds-wrap slds-gutters_small">

                    <div class="slds-col slds-size_1-of-1">
                        <lightning-input type="date" label="Pickup Date" data-id="shipmentDate"
                            value={shipment.Shipment_Date__c} min={minDate} max={maxDate}
                            onchange={handleShipmentDate} message-when-bad-input="Invalid date"
                            required>
                        </lightning-input>
                    </div>

                    <div class="slds-col slds-size_1-of-1">
                        <lightning-input type="text" label="Description" data-id="description"
                            value={shipment.Description__c} onchange={handleInputChange}
                            placeholder="Enter description">
                        </lightning-input>
                    </div>

                    <div class="slds-col slds-size_1-of-1">
                        <lightning-input label="Billing Account Number"
                            data-id="billingAccountNumber" placeholder="Enter account number"
                            value={shipment.Billing_Account_Number__c} onchange={handleInputChange}>
                        </lightning-input>
                    </div>

                    <div class="slds-col slds-size_1-of-1">
                        <label for="">Billing Contact</label>
                        <c-custom-input-lookup-l-w-c obj-name="Contact"
                            search-placeholder="Billing Contact" icon-name="standard:contact"
                            is-value-selected={isBillingContactSelected} selected-value={shipment.Billing_Contact__c}> 
                        </c-custom-input-lookup-l-w-c>
                    </div>

                    <div class="slds-col slds-size_1-of-1">
                        <lightning-combobox
                            label="Billing Options"
                            value={shipment.Shipment_Billing_options__c}
                            options={billingOptions}
                            onchange={handleBillingChange}>
                        </lightning-combobox>
                    </div>

                    <div class="slds-col slds-size_1-of-1">
                        <label for="">Billing Address</label>
                        <c-custom-input-lookup-l-w-c obj-name="Address__c"
                            search-placeholder="Billing address" icon-name="standard:address"
                            is-value-selected={isBillingAddressSelected} selected-value={shipment.Billing_Address__c}
                            selected-name={BillingAddressName} selected-name-url={BillingAddressUrl}> 
                        </c-custom-input-lookup-l-w-c>
                    </div>

                    <template if:true={showCreateShipment}>   
                        <div class="slds-col slds-size_1-of-1 slds-m-top_small">
                            <button class="slds-button slds-button_brand" style="width: 100%;"
                                onclick={createShipment}>Create Shipment</button>
                        </div>
                    </template>
                    
                    <template if:true={isPending}>
                        <div class="slds-col slds-size_1-of-1 slds-m-top_small">
                            <button class="slds-button slds-button_brand" style="width: 100%;" onclick={getQuotes}>
                                Get Quotes
                            </button>
                        </div>
                    </template>
                    
                    <template lwc:if={docIds.bol}>
                        <div class="slds-col slds-size_6-of-12 slds-m-top_small">
                            <button class="slds-button slds-button_brand slds-m-horizontal_x-small"
                                data-type="bol"
                                onclick={openPreview}>
                            BOL
                            </button>
                        </div>
                    </template>

                    <template lwc:if={docIds.label}>
                        <div class="slds-col slds-size_6-of-12 slds-m-top_small slds-text-align_right">
                            <button class="slds-button slds-button_brand slds-m-horizontal_x-small"
                                data-type="label"
                                onclick={openPreview}>
                            View Label
                            </button>
                        </div>
                    </template>

                </div>
            </div>
        </template>

        <template if:true={isRfqsActive}>
            <div class="slds-p-horizontal_small slds-p-vertical_small">
                <div class="slds-box slds-m-bottom_medium">
                    <div class="slds-text-heading_small slds-m-bottom_small">Request Quotes (RFQ)</div>
                    <div class="slds-grid slds-wrap slds-gutters_small">
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
                            <lightning-textarea
                            label="Emails (comma-separated)"
                            value={rfqEmailsText}
                            onchange={handleRfqEmailsChange}
                            placeholder="e.g. carrier-a@ex.com, ops@carrier-b.com">
                            </lightning-textarea>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
                            <lightning-textarea
                            label="Message (optional)"
                            value={rfqMessage}
                            onchange={handleRfqMessageChange}
                            placeholder="Add any special instructions for this RFQ">
                            </lightning-textarea>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-m-top_small">
                            <lightning-button
                            label="Send RFQ"
                            variant="brand"
                            onclick={sendRfq}
                            disabled={rfqSending}>
                            </lightning-button>
                            <lightning-button
                            class="slds-m-left_small"
                            label="Refresh Quotes"
                            onclick={getQuotes}
                            disabled={isLoading}>
                            </lightning-button>
                        </div>
                    </div>
                </div>

                <div class="slds-box">
                    <div class="slds-text-heading_small slds-m-bottom_small">Requested From</div>
                    <template if:true={hasRequestedFrom}>
                    <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-m-bottom_large">
                        <thead>
                        <tr>
                            <th>Carrier</th>
                            <th>Email</th>
                            <th>Requested</th>
                            <th>Responded</th>
                            <th>Declined</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template for:each={requestedFromList} for:item="r">
                            <tr key={r.key}>
                            <td>{r.carrierName}</td>
                            <td>{r.email}</td>
                            <td>{r.requestDateDisplay}</td>
                            <td>{r.hasRespondedDisplay}</td>
                            <td>{r.hasDeclinedDisplay}</td>
                            </tr>
                        </template>
                        </tbody>
                    </table>
                    </template>
                    <template if:false={hasRequestedFrom}>
                    <div class="slds-text-color_weak">No RFQ requests found yet. Use “Send RFQ” above.</div>
                    </template>

                    <div class="slds-text-heading_small slds-m-bottom_small">Quotes</div>
                    <template if:true={hasQuotes}>
                    <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                        <thead>
                        <tr>
                            <th>Carrier</th>
                            <th>Provider</th>
                            <th>Equipment</th>
                            <th>Mode</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Created</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template for:each={quotes} for:item="q">
                            <tr key={q.quoteId}>
                            <td>{q.assetCarrierName}</td>
                            <td>{q.providerName}</td>
                            <td>{q.equipmentType}</td>
                            <td>{q.mode}</td>
                            <td>{q.amount} {q.currency}</td>
                            <td>{q.status}</td>
                            <td>{q.createdDate}</td>
                            </tr>
                        </template>
                        </tbody>
                    </table>
                    </template>
                    <template if:false={hasQuotes}>
                    <div class="slds-text-color_weak">No quotes returned yet.</div>
                    </template>
                </div>
            </div>
        </template>

        <template if:true={isManualQuoteActive}>
            <div class="slds-p-horizontal_small slds-p-vertical_small">
                <div class="slds-box slds-m-bottom_medium">
                    <div class="slds-text-heading_small slds-m-bottom_small">Add Manual Quote</div>

                    <div class="slds-grid slds-wrap slds-gutters_small">
                        <div class="slds-col slds-size_1-of-1 slds-large-size_4-of-12">
                            <lightning-input type="number" label="Amount" value={mqAmount}
                            onchange={handleMqChange} data-id="amount" min="1" required>
                            </lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-1 slds-large-size_4-of-12">
                            <lightning-combobox label="Currency" value={mqCurrency}
                            options={currencyOptions} onchange={handleMqChange} data-id="currency">
                            </lightning-combobox>
                        </div>

                        <div class="slds-col slds-size_1-of-1 slds-large-size_4-of-12">
                            <lightning-input type="email" label="Carrier Email" value={mqCarrierEmail}
                            onchange={handleMqChange} data-id="carrierEmail" required>
                            </lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-1 slds-large-size_4-of-12">
                            <lightning-input type="text" label="Auto-create Carrier Name (fallback)"
                            value={mqAutoCreateCarrierName} onchange={handleMqChange} data-id="autoCreateCarrierName">
                            </lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-1 slds-large-size_4-of-12">
                            <lightning-input type="text" label="Carrier Display Name"
                            value={mqCarrierName} onchange={handleMqChange} data-id="carrierName">
                            </lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-1 slds-large-size_4-of-12">
                            <lightning-input type="text" label="Quote #" value={mqQuoteNum}
                            onchange={handleMqChange} data-id="quoteNum">
                            </lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-1 slds-large-size_4-of-12">
                            <lightning-input type="datetime-local" label="Expires At (UTC)"
                            value={mqExpiresAt} onchange={handleMqChange} data-id="expiresAt">
                            </lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-1 slds-large-size_4-of-12">
                            <lightning-input type="number" label="Transit Days"
                            value={mqTransitDays} onchange={handleMqChange} data-id="transitDays" min="1">
                            </lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-1 slds-large-size_4-of-12">
                            <lightning-combobox label="Equipment Type"
                            value={mqEquipmentType} options={equipmentTypeOptions}
                            onchange={handleMqChange} data-id="equipmentType">
                            </lightning-combobox>
                        </div>

                        <div class="slds-col slds-size_1-of-1">
                            <lightning-textarea label="Notes" value={mqNotes}
                            onchange={handleMqChange} data-id="notes" maxlength="500">
                            </lightning-textarea>
                        </div>
                        <div class="slds-col slds-size_1-of-1">
                            <lightning-combobox label="Service Type" value={mqServiceId} options={serviceOptions} onchange={handleMqChange} data-id="serviceId"></lightning-combobox>
                        </div>
                        <div class="slds-col slds-size_1-of-1">
                            <lightning-input type="text" label="Service Description" value={mqServiceDescription} onchange={handleMqChange} data-id="serviceDescription"></lightning-input>
                        </div>
                        
                        <div class="slds-col slds-size_1-of-1 slds-m-top_small">
                           <button class="slds-button slds-button_brand" 
                                onclick={handleAddManualQuote} 
                                disabled={mqSubmitting}>
                            Add Manual Quote
                        </button>
                            <lightning-button class="slds-m-left_small" label="Refresh Quotes"
                            onclick={getQuotes} disabled={isLoading}>
                            </lightning-button>
                        </div>
                    </div>
                </div>
                
                <div class="slds-p-around_medium">
                    <div class="slds-text-heading_small slds-m-bottom_small">
                        Manual Quotes (Awarded) — {FVshipmentID}
                    </div>

                    <template if:true={hasManualQuotes}>
                        <lightning-datatable
                            key-field="quoteId"
                            data={manualQuotes}
                            columns={columns}
                            onrowaction={handleRowAction}
                            selected-rows={selectedRowIds}>
                        </lightning-datatable>
                    </template>
                    <template if:false={hasManualQuotes}>
                        <div class="slds-text-color_weak">No awarded manual quotes found for this shipment.</div>
                    </template>

                    <div class="slds-m-top_medium slds-grid slds-wrap slds-gutters">
                        <div class="slds-col slds-size_1-of-1 slds-large-size_4-of-12">
                            <lightning-input
                                type="text"
                                label="Pickup Confirmation Number"
                                value={pickupConfNum}
                                onchange={handleInputChange}
                                data-id="pickupConfNum"
                                required>
                            </lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-1 slds-large-size_8-of-12 slds-align_absolute-center">
                            <lightning-button
                                variant="brand"
                                label="Confirm Shipment"
                                title="Confirm"
                                class="slds-m-right_small"
                                onclick={handleConfirm}
                                disabled={confirmDisabled}>
                            </lightning-button>

                            <lightning-button
                                label="Refresh"
                                onclick={loadManualQuotes}
                                variant="neutral">
                            </lightning-button>
                        </div>
                    </div>

                    <template if:true={selectedQuote}>
                        <div class="slds-box slds-m-top_medium">
                            <div class="slds-text-title_caps slds-m-bottom_xx-small">Selected Manual Quote</div>
                            <div class="slds-text-body_regular">
                                <b>Carrier:</b> {selectedQuote.assetCarrierName} &nbsp;|&nbsp;
                                <b>Service:</b> {selectedQuote.serviceDescription} &nbsp;|&nbsp;
                                <b>Amount:</b> {selectedQuote.amountFormatted}
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>
        
        <template if:true={isTrackActive}>
            <div class="slds-p-horizontal_small slds-p-vertical_small">
                <div class="slds-grid slds-wrap slds-gutters_small">
                    <div class="slds-col slds-size_1-of-1">
                        <lightning-input 
                            label="Shipment Id"
                            value={FVshipmentID} readonly>
                        </lightning-input>
                    </div>

                    <div class="slds-col slds-size_1-of-1 slds-m-top_small">
                        <template if:true={isTruckload}>
                            <lightning-button 
                                label="Cancel Shipment" 
                                variant="neutral"
                                onclick={handleCancelShipment}
                                class="slds-m-right_small">
                            </lightning-button>
                        </template>
                        
                        <button class="slds-button slds-button_brand" 
                            onclick={handleTrackShipment}>Track Shipment</button>
                    </div>

                    <div class="slds-col slds-size_1-of-1 slds-m-top_large">
                        <h3 class="slds-text-heading_medium slds-text-align_center slds-p-bottom_medium">
                            Tracking Details of the Shipment
                        </h3>

                        <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                            <thead>
                                <tr>
                                    <th>Date / Time</th>
                                    <th>Event Type</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template if:true={hasTracking}>
                                    <template for:each={trackingList} for:item="event">
                                        <tr key={event.createdDate}>
                                            <td>{event.eventDate} {event.eventTime}</td>
                                            <td>{event.eventType}</td>
                                            <td>{event.summary}</td>
                                        </tr>
                                    </template>
                                </template>
                                <template if:false={hasTracking}>
                                    <tr>
                                        <td colspan="3" class="slds-text-align_center">
                                            No tracking events available.
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </template>
        
    </div>
</div>


                 <!-- End New tabs -->

                </div>

                <!-- <div class="slds-m-bottom_medium slds-border_bottom slds-border_left slds-border_right slds-border_top"
                    style="border-radius: 4px; background: white;border:0px solid #ede8e8;">
                    <div class="slds-p-around_x-small slds-text-heading_small"
                        style="border-bottom: 1px solid #e0e5ee;">
                        <lightning-icon icon-name="action:new_note" size="x-small"
                            class="slds-m-right_x-small"></lightning-icon>
                        <span class="slds-text-heading_small">End-User License Agreement</span>
                    </div>
                    <div class="slds-p-horizontal_small slds-p-vertical_small">
                        <h4 class="slds-text-heading_small slds-m-bottom_x-small">Appendix A-1</h4>
                        <p class="slds-text-body_small">
                            If your Developer is a FEDEX ASP Agreement, this EULA is to be included in Your FedEx®
                            Compatible Solution, subject to and in accordance with Your Developer Agreement. To use Your
                            FedEx Solution (as defined below), you must have a FedEx Developer Account. This Agreement
                            gives each of us certain rights and responsibilities. You will be assuming full and sole
                            responsibility for all
                        </p>
                    </div>
                </div> -->

            </div>

        </div>
</template>
 <template if:true={isShipmentRatesOpen}>
       <template if:true={shipment}>
        <c-shippment-rates
            class="full-page"
            from-address={fromAddress}
            to-address={toAddress}
            from-contact={fromContact}
            to-contact={toContact}
            package-list={packageList}
            quotes={quotes}
            shipment={shipment}
            credentials={credentials}
            shipment-mode={shipmentMode}
            onbacktoparent={handleBackFromShipmentRates}>
        </c-shippment-rates>
    </template>

    </template>

    </div>
     
</template>